import asyncio
import logging
from datetime import datetime
from typing import Dict, List
import os
from dotenv import load_dotenv

from aiogram import Bot, Dispatcher, F
from aiogram.types import Message, CallbackQuery
from aiogram.filters import Command
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.types import InlineKeyboardButton, ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove

import sys
import os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from database import db
from config import (
    SCIENCE_DATA, 
    PERSONAL_GOALS, 
    MISSION_EMOJIS, 
    MISSION_TITLES, 
    MISSION_DESCRIPTIONS
)
from ai_analyzer import ai_analyzer

# Load environment variables
load_dotenv()

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Initialize bot and dispatcher
BOT_TOKEN = os.getenv("BOT_TOKEN")
if not BOT_TOKEN:
    raise ValueError("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ BOT_TOKEN –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")

bot = Bot(token=BOT_TOKEN)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)


def create_main_menu_keyboard():
    """Create main menu keyboard with emoji buttons"""
    keyboard = InlineKeyboardBuilder()
    
    keyboard.button(text="üìä –î–∞—à–±–æ—Ä–¥", callback_data="dashboard")
    keyboard.button(text="üéØ –ú–∏—Å—Å–∏–∏ –¥–Ω—è", callback_data="missions")
    keyboard.button(text="üìù –î–Ω–µ–≤–Ω–∏–∫", callback_data="journal")
    keyboard.button(text="üó∫Ô∏è –ö–∞—Ä—Ç–∞ —ç–Ω–µ—Ä–≥–∏–∏", callback_data="energy_map")
    keyboard.button(text="üìà –ù–µ–¥–µ–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞", callback_data="analytics")
    keyboard.button(text="üîç –ê–Ω–∞–ª–∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è", callback_data="environment_analysis")
    keyboard.button(text="üî¨ –ù–∞—É—á–Ω—ã–µ —Ñ–∞–∫—Ç—ã", callback_data="science_facts")
    
    keyboard.adjust(2)  # 2 buttons per row
    return keyboard.as_markup()


def create_missions_keyboard(missions: List[Dict]):
    """Create keyboard for today's missions"""
    keyboard = InlineKeyboardBuilder()
    
    for mission in missions:
        status = "‚è±Ô∏è –ê–∫—Ç–∏–≤–µ–Ω" if mission.get('is_active') else "‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç"
        button_text = f"{MISSION_EMOJIS.get(mission['type'], 'üìù')} {mission['title']} - {status}"
        
        if mission.get('is_active'):
            # Show stop button for active mission
            keyboard.button(
                text=f"‚èπÔ∏è –°—Ç–æ–ø {MISSION_EMOJIS.get(mission['type'], 'üìù')}", 
                callback_data=f"stop_timer_{mission['id']}"
            )
        else:
            # Show start button for inactive mission
            keyboard.button(
                text=f"‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç {MISSION_EMOJIS.get(mission['type'], 'üìù')}", 
                callback_data=f"start_timer_{mission['id']}"
            )
    
    keyboard.button(text="üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="main_menu")
    keyboard.adjust(1)  # 1 button per row
    return keyboard.as_markup()


def create_science_facts_keyboard():
    """Create keyboard for science facts"""
    keyboard = InlineKeyboardBuilder()
    
    for category, data in SCIENCE_DATA.items():
        emoji = MISSION_EMOJIS.get(category, '‚ùì')
        keyboard.button(
            text=f"{emoji} {category.replace('_', ' ').title()} Facts", 
            callback_data=f"science_{category}"
        )
    
    keyboard.button(text="üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="main_menu")
    keyboard.adjust(1)
    return keyboard.as_markup()


async def generate_dashboard(user_id: int) -> str:
    """Generate dashboard with user progress"""
    # Get today's missions
    missions = db.get_todays_missions(user_id)
    
    # Get active timer if any
    active_timer = db.get_active_timer(user_id)
    
    # Get weekly analytics
    weekly_analytics = db.get_weekly_analytics(user_id)
    
    dashboard = "üè† <b>–õ–ò–§–ï–û–° –°–¢–†–ê–ñ –î–ê–®–ë–û–†–î</b>\n\n"
    
    # Today's missions
    dashboard += "<b>–ú–∏—Å—Å–∏–∏ —Å–µ–≥–æ–¥–Ω—è:</b>\n"
    if missions:
        for mission in missions:
            status = "‚úÖ –ê–∫—Ç–∏–≤–Ω–∞" if mission.get('is_active') else "‚è≥ –í –æ–∂–∏–¥–∞–Ω–∏–∏"
            emoji = MISSION_EMOJIS.get(mission['type'], 'üìù')
            dashboard += f"‚Ä¢ {emoji} {mission['title']} - {status}\n"
    else:
        dashboard += "–°–µ–≥–æ–¥–Ω—è –Ω–µ—Ç –º–∏—Å—Å–∏–π. –î–æ–±–∞–≤—å—Ç–µ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ!\n"
    
    # Active timer info
    if active_timer:
        dashboard += f"\n<b>–ê–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–π–º–µ—Ä:</b>\n"
        dashboard += f"‚è±Ô∏è {active_timer['mission_title']} - {active_timer['elapsed_minutes']} –º–∏–Ω –ø—Ä–æ—à–ª–æ\n"
    
    # Weekly analytics summary
    dashboard += f"\n<b>–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å:</b>\n"
    if weekly_analytics:
        for mission_type, data in weekly_analytics.items():
            emoji = MISSION_EMOJIS.get(mission_type, '‚ùì')
            completion_rate = data.get('completion_rate', 0)
            total_minutes = data.get('total_minutes', 0)
            dashboard += f"‚Ä¢ {emoji} {mission_type.title()}: {completion_rate}% ({total_minutes} min)\n"
    else:
        dashboard += "–î–∞–Ω–Ω—ã–µ –ø–æ–∫–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã.\n"
    
    dashboard += f"\nüí° <i>{SCIENCE_DATA['sleep']['motivational_quote']}</i>"
    
    return dashboard


async def generate_missions_list(user_id: int) -> str:
    """Generate list of today's missions"""
    missions = db.get_todays_missions(user_id)
    
    if not missions:
        return "üéØ <b>–°–µ–≥–æ–¥–Ω—è –Ω–µ—Ç –º–∏—Å—Å–∏–π!</b>\n\n–í–∞—à AI-—Å—Ç—Ä–∞–∂ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –º–∏—Å—Å–∏–∏, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å –≤–∞–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–∞—à—É –∂–∏–∑–Ω—å."
    
    missions_text = "üéØ <b>–ú–∏—Å—Å–∏–∏ –¥–Ω—è:</b>\n\n"
    for i, mission in enumerate(missions, 1):
        status = "‚è±Ô∏è –ê–∫—Ç–∏–≤–Ω–∞" if mission.get('is_active') else "‚è≥ –í –æ–∂–∏–¥–∞–Ω–∏–∏"
        emoji = MISSION_EMOJIS.get(mission['type'], 'üìù')
        duration = mission.get('target_duration', 0)
        
        missions_text += f"<b>{i}. {emoji} {mission['title']}</b>\n"
        missions_text += f"   ‚Ä¢ –¢–∏–ø: {mission['type'].replace('_', ' ').title()}\n"
        missions_text += f"   ‚Ä¢ –¶–µ–ª—å: {duration} –º–∏–Ω\n"
        missions_text += f"   ‚Ä¢ –°—Ç–∞—Ç—É—Å: {status}\n"
        if mission.get('duration_minutes'):
            missions_text += f"   ‚Ä¢ –¢–µ–∫—É—â–µ–µ: {mission['duration_minutes']} –º–∏–Ω\n"
        missions_text += "\n"
    
    return missions_text


async def generate_weekly_analytics(user_id: int) -> str:
    """Generate weekly analytics report"""
    analytics = db.get_weekly_analytics(user_id)
    
    if not analytics:
        return "üìà <b>–ù–µ–¥–µ–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</b>\n\n–î–∞–Ω–Ω—ã–µ –ø–æ–∫–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏—Å—Å–∏–π, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å!"
    
    analytics_text = "üìà <b>–û—Ç—á–µ—Ç –ø–æ –Ω–µ–¥–µ–ª—å–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–µ</b>\n\n"
    
    for mission_type, data in analytics.items():
        emoji = MISSION_EMOJIS.get(mission_type, '‚ùì')
        total_minutes = data.get('total_minutes', 0)
        completed_sessions = data.get('completed_sessions', 0)
        planned_sessions = data.get('planned_sessions', 0)
        completion_rate = data.get('completion_rate', 0)
        
        analytics_text += f"<b>{emoji} {mission_type.replace('_', ' ').title()}</b>\n"
        analytics_text += f"   ‚Ä¢ –û–±—â–µ–µ –≤—Ä–µ–º—è: {total_minutes} –º–∏–Ω\n"
        analytics_text += f"   ‚Ä¢ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: {completed_sessions}/{planned_sessions} —Å–µ—Å—Å–∏–π\n"
        analytics_text += f"   ‚Ä¢ –ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {completion_rate}%\n\n"
    
    return analytics_text


async def generate_journal_entries(user_id: int) -> str:
    """Generate journal entries for the user"""
    entries = db.get_journal_entries(user_id, days=7)
    
    if not entries:
        return "üìù <b>–¶–∏—Ñ—Ä–æ–≤–æ–π –¥–Ω–µ–≤–Ω–∏–∫ (–∞–≤—Ç–æ–∞–Ω–∞–ª–∏–∑)</b>\n\n–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å AI-–∞–Ω–∞–ª–∏–∑!"
    
    journal_text = "üìù <b>–¶–∏—Ñ—Ä–æ–≤–æ–π –¥–Ω–µ–≤–Ω–∏–∫ (–∞–≤—Ç–æ–∞–Ω–∞–ª–∏–∑)</b>\n\n"
    
    for i, entry in enumerate(entries[:5]):  # Show last 5 entries
        timestamp = datetime.fromisoformat(entry['timestamp']).strftime("%H:%M - %d %b")
        journal_text += f"<b>{timestamp}</b> - {entry['activity']}\n"
        journal_text += f"   ü§ñ AI-–æ—Ü–µ–Ω–∫–∞: {entry['ai_analysis']}\n"
        if entry['duration']:
            journal_text += f"   ‚è∞ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {entry['duration']} –º–∏–Ω\n"
        journal_text += f"   üíé –¶–µ–Ω–Ω–æ—Å—Ç—å: {entry['value_score']}/10\n\n"
    
    return journal_text


async def generate_energy_map(user_id: int) -> str:
    """Generate energy map for the day"""
    now = datetime.now()
    current_hour = now.hour
    
    energy_map = "üó∫Ô∏è <b>–ö–ê–†–¢–ê –¢–í–û–ï–ô –≠–ù–ï–†–ì–ò–ò (—Å–µ–≥–æ–¥–Ω—è)</b>\n\n"
    
    # Display energy levels for different times of day
    time_periods = [
        (range(0, 6), "–ü–û–ó–î–ù–Ø–Ø –ù–û–ß–¨"),
        (range(6, 10), "–£–¢–†–û"),
        (range(10, 14), "–î–ï–ù–¨"),
        (range(14, 17), "–°–ï–†–ï–î–ò–ù–ê –î–ù–Ø"),
        (range(17, 21), "–í–ï–ß–ï–†"),
        (range(21, 24), "–ù–û–ß–¨")
    ]
    
    for time_range, period_name in time_periods:
        if current_hour in time_range:
            energy_desc = ai_analyzer.generate_energy_map(current_hour)
            energy_map += f"‚îÇ <b>{period_name}</b>: {energy_desc} (<b>–°–ï–ô–ß–ê–°</b>)\n"
        else:
            # Just get the energy level without marking as current
            temp_hour = next(iter(time_range))
            energy_desc = ai_analyzer.generate_energy_map(temp_hour)
            # Remove the extra text to just show the emoji rating
            energy_rating = energy_desc.split(" ", 1)[0]  # Get just the emoji rating
            energy_map += f"‚îÇ <b>{period_name}</b>: {energy_rating}\n"
    
    energy_map += "\nüí° <i>–°–æ–≤–µ—Ç: –ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ —Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏ –Ω–∞ –ø–µ—Ä–∏–æ–¥—ã —Å –≤—ã—Å–æ–∫–æ–π —ç–Ω–µ—Ä–≥–∏–µ–π!</i>"
    
    return energy_map


async def generate_environment_analysis(user_id: int) -> str:
    """Generate environment analysis based on journal entries"""
    analysis = db.get_environment_analysis(user_id)
    
    env_text = "üîç <b>–ê–ù–ê–õ–ò–ó –û–ö–†–£–ñ–ï–ù–ò–Ø (–∑–∞ –Ω–µ–¥–µ–ª—é)</b>\n\n"
    
    # Positive influences
    env_text += "<b>‚úÖ –ü–æ–∑–∏—Ç–∏–≤–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ:</b>\n"
    if analysis['positive_influences']:
        for influence in analysis['positive_influences']:
            env_text += f"   ‚Ä¢ {influence['activity']} ({influence['score']}/10, {influence['count']} —Ä–∞–∑)\n"
    else:
        env_text += "   –ü–æ–∫–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ\n"
    
    env_text += "\n<b>‚ö†Ô∏è –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ:</b>\n"
    if analysis['neutral_influences']:
        for influence in analysis['neutral_influences']:
            env_text += f"   ‚Ä¢ {influence['activity']} ({influence['score']}/10, {influence['count']} —Ä–∞–∑)\n"
    else:
        env_text += "   –ü–æ–∫–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ\n"
    
    env_text += "\n<b>üö´ –¢–æ–∫—Å–∏—á–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ:</b>\n"
    if analysis['toxic_influences']:
        for influence in analysis['toxic_influences']:
            env_text += f"   ‚Ä¢ {influence['activity']} ({influence['score']}/10, {influence['count']} —Ä–∞–∑)\n"
    else:
        env_text += "   –ü–æ–∫–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ\n"
    
    # Add recommendations
    if analysis['toxic_influences']:
        toxic_example = analysis['toxic_influences'][0]['activity'] if analysis['toxic_influences'] else "–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è"
        env_text += f"\nüí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: \"–ó–∞–º–µ–Ω–∏ {analysis['toxic_influences'][0]['duration'] or 30} –º–∏–Ω—É—Ç {toxic_example} –Ω–∞ –±–æ–ª–µ–µ –ø–æ–ª–µ–∑–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å. "
        env_text += "–≠—Ñ—Ñ–µ–∫—Ç: +28% –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è, -15% —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç–∏\""
    
    return env_text


async def generate_science_fact(category: str) -> str:
    """Generate science fact for a specific category"""
    if category not in SCIENCE_DATA:
        return f"‚ùå No science data found for {category}"
    
    data = SCIENCE_DATA[category]
    emoji = MISSION_EMOJIS.get(category, '‚ùì')
    
    fact_text = f"{emoji} <b>–ù–∞—É—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {category.replace('_', ' ').title()}</b>\n\n"
    
    if 'optimal_hours' in data:
        fact_text += f"üî¨ <b>–û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:</b> {data['optimal_hours']} hours\n"
    elif 'daily_minutes' in data:
        fact_text += f"üî¨ <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –≤ –¥–µ–Ω—å:</b> {data['daily_minutes']} minutes\n"
    elif 'daily_liters' in data:
        fact_text += f"üî¨ <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –≤ –¥–µ–Ω—å:</b> {data['daily_liters']} liters\n"
    
    if 'benefits' in data:
        fact_text += f"\nüåü <b>–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:</b>\n"
        for benefit in data['benefits']:
            fact_text += f"   ‚Ä¢ {benefit}\n"
    
    if 'motivational_quote' in data:
        fact_text += f"\nüí° <i>{data['motivational_quote']}</i>"
    
    return fact_text


async def initialize_daily_missions(user_id: int):
    """Initialize daily missions based on personal goals"""
    user_goals = PERSONAL_GOALS.get('toprudik', {})
    
    missions = []
    
    # Sleep mission
    if 'sleep_target' in user_goals:
        missions.append({
            'type': 'sleep',
            'title': MISSION_TITLES['sleep'],
            'description': MISSION_DESCRIPTIONS['sleep'],
            'target_duration': user_goals['sleep_target'] * 60  # Convert hours to minutes
        })
    
    # Exercise mission
    if 'exercise_target' in user_goals:
        missions.append({
            'type': 'exercise',
            'title': MISSION_TITLES['exercise'],
            'description': MISSION_DESCRIPTIONS['exercise'],
            'target_duration': user_goals['exercise_target']
        })
    
    # Family time mission
    if 'family_time_target' in user_goals:
        missions.append({
            'type': 'family',
            'title': MISSION_TITLES['family'],
            'description': MISSION_DESCRIPTIONS['family'],
            'target_duration': user_goals['family_time_target'] * 60  # Convert hours to minutes
        })
    
    # Deep work mission
    if 'deep_work_target' in user_goals:
        missions.append({
            'type': 'deep_work',
            'title': MISSION_TITLES['deep_work'],
            'description': MISSION_DESCRIPTIONS['deep_work'],
            'target_duration': user_goals['deep_work_target']
        })
    
    # Hydration mission
    if 'hydration_target' in user_goals:
        missions.append({
            'type': 'hydration',
            'title': MISSION_TITLES['hydration'],
            'description': MISSION_DESCRIPTIONS['hydration'],
            'target_duration': int(user_goals['hydration_target'] * 1000 / 250)  # Convert liters to glasses (assuming 250ml per glass)
        })
    
    db.create_daily_missions(user_id, missions)


def generate_morning_greeting() -> str:
    """Generate personalized morning greeting based on time of day"""
    current_hour = datetime.now().hour
    
    if 5 <= current_hour < 12:
        time_greeting = "üåÖ –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!"
        motivation = "–°–µ–≥–æ–¥–Ω—è –Ω–æ–≤—ã–π –¥–µ–Ω—å, –ø–æ–ª–Ω—ã–π –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π. –ù–∞—á–Ω–∏ —Å –º–∞–ª–µ–Ω—å–∫–æ–π –ø–æ–±–µ–¥—ã!"
    elif 12 <= current_hour < 17:
        time_greeting = "‚òÄÔ∏è –î–æ–±—Ä—ã–π –¥–µ–Ω—å!"
        motivation = "–°–µ—Ä–µ–¥–∏–Ω–∞ –¥–Ω—è - –≤—Ä–µ–º—è –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –≤–∞–∂–Ω—ã—Ö –¥–µ–ª!"
    elif 17 <= current_hour < 22:
        time_greeting = "üåá –î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä!"
        motivation = "–í–µ—á–µ—Ä - –≤—Ä–µ–º—è –¥–ª—è –ø–æ–¥–≤–µ–¥–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è."
    else:
        time_greeting = "üåô –î–æ–±—Ä–æ–π –Ω–æ—á–∏!"
        motivation = "–ü–æ—Ä–∞ –≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫–æ —Å–Ω—É –¥–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è."
    
    # Add scientific fact
    science_tip = ai_analyzer.generate_science_tip_of_the_day()
    
    greeting = f"{time_greeting}\n\n{motivation}\n\n{science_tip}"
    
    return greeting


@dp.message(Command("start"))
async def cmd_start(message: Message):
    """Handle /start command"""
    user = db.get_or_create_user(message.from_user.id, message.from_user.username)
    
    # Initialize daily missions for new users
    initialize_daily_missions(user['id'])
    
    # Get personalized greeting
    greeting = generate_morning_greeting()
    
    welcome_message = (
        f"ü§ñ <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –õ–ò–§–ï–û–° –°–¢–†–ê–ñ!</b>\n\n"
        f"{greeting}\n\n"
        f"–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∂–∏–∑–Ω–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞—É—á–Ω—ã—Ö "
        f"–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π –∏–∑ Mayo Clinic, –ì–∞—Ä–≤–∞—Ä–¥—Å–∫–æ–≥–æ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞ –∏ –°—Ç—ç–Ω—Ñ–æ—Ä–¥–∞.\n\n"
        f"üéØ –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Å–≤–æ–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –º–∏—Å—Å–∏–∏\n"
        f"üìù –í–µ–¥–∏—Ç–µ —Ü–∏—Ñ—Ä–æ–≤–æ–π –¥–Ω–µ–≤–Ω–∏–∫ —Å AI-–∞–Ω–∞–ª–∏–∑–æ–º\n"
        f"üìä –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ —Å–≤–æ–π –Ω–µ–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å\n"
        f"üó∫Ô∏è –ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ –¥–µ–Ω—å –ø–æ —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–æ–π –∫–∞—Ä—Ç–µ\n"
        f"üî¨ –ò–∑—É—á–∞–π—Ç–µ –Ω–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã\n\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å:"
    )
    
    await message.answer(welcome_message, reply_markup=create_main_menu_keyboard())


@dp.callback_query(F.data == "main_menu")
async def show_main_menu(callback: CallbackQuery):
    """Show main menu"""
    await callback.message.edit_text(
        "üè† <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é:",
        reply_markup=create_main_menu_keyboard()
    )
    await callback.answer()


@dp.callback_query(F.data == "dashboard")
async def show_dashboard(callback: CallbackQuery):
    """Show dashboard with user progress"""
    user = db.get_or_create_user(callback.from_user.id, callback.from_user.username)
    dashboard_text = await generate_dashboard(user['id'])
    
    await callback.message.edit_text(
        dashboard_text,
        reply_markup=create_main_menu_keyboard(),
        parse_mode="HTML"
    )
    await callback.answer()


@dp.callback_query(F.data == "missions")
async def show_missions(callback: CallbackQuery):
    """Show today's missions"""
    user = db.get_or_create_user(callback.from_user.id, callback.from_user.username)
    missions_text = await generate_missions_list(user['id'])
    
    # Get missions to create appropriate keyboard
    missions = db.get_todays_missions(user['id'])
    
    await callback.message.edit_text(
        missions_text,
        reply_markup=create_missions_keyboard(missions),
        parse_mode="HTML"
    )
    await callback.answer()


@dp.callback_query(F.data.startswith("start_timer_"))
async def start_timer(callback: CallbackQuery):
    """Start a timer for a mission"""
    mission_id = int(callback.data.split("_")[2])
    user = db.get_or_create_user(callback.from_user.id, callback.from_user.username)
    
    success = db.start_timer(user['id'], mission_id)
    
    if success:
        await callback.answer("‚úÖ –¢–∞–π–º–µ—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!", show_alert=True)
    else:
        await callback.answer("‚ö†Ô∏è –¢–∞–π–º–µ—Ä —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω –¥–ª—è —ç—Ç–æ–π –º–∏—Å—Å–∏–∏!", show_alert=True)
    
    # Refresh missions display
    missions_text = await generate_missions_list(user['id'])
    missions = db.get_todays_missions(user['id'])
    
    await callback.message.edit_text(
        missions_text,
        reply_markup=create_missions_keyboard(missions),
        parse_mode="HTML"
    )


@dp.callback_query(F.data.startswith("stop_timer_"))
async def stop_timer(callback: CallbackQuery):
    """Stop an active timer"""
    timer_id = int(callback.data.split("_")[2])
    
    success = db.complete_timer(timer_id)
    
    if success:
        await callback.answer("‚úÖ –¢–∞–π–º–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∑–∞–ø–∏—Å–∞–Ω!", show_alert=True)
    else:
        await callback.answer("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä. –£–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω –∏–ª–∏ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω.", show_alert=True)
    
    # Refresh missions display
    user = db.get_or_create_user(callback.from_user.id, callback.from_user.username)
    missions_text = await generate_missions_list(user['id'])
    missions = db.get_todays_missions(user['id'])
    
    await callback.message.edit_text(
        missions_text,
        reply_markup=create_missions_keyboard(missions),
        parse_mode="HTML"
    )


@dp.callback_query(F.data == "analytics")
async def show_analytics(callback: CallbackQuery):
    """Show weekly analytics"""
    user = db.get_or_create_user(callback.from_user.id, callback.from_user.username)
    analytics_text = await generate_weekly_analytics(user['id'])
    
    await callback.message.edit_text(
        analytics_text,
        reply_markup=create_main_menu_keyboard(),
        parse_mode="HTML"
    )
    await callback.answer()


@dp.callback_query(F.data == "journal")
async def show_journal(callback: CallbackQuery):
    """Show journal entries"""
    user = db.get_or_create_user(callback.from_user.id, callback.from_user.username)
    journal_text = await generate_journal_entries(user['id'])
    
    # Create keyboard with options to add new entries
    keyboard = InlineKeyboardBuilder()
    keyboard.button(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å", callback_data="add_journal_entry")
    keyboard.button(text="ü§ñ –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑", callback_data="full_analysis")
    keyboard.button(text="üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")
    keyboard.adjust(2)
    
    await callback.message.edit_text(
        journal_text,
        reply_markup=keyboard.as_markup(),
        parse_mode="HTML"
    )
    await callback.answer()


@dp.callback_query(F.data == "energy_map")
async def show_energy_map(callback: CallbackQuery):
    """Show energy map for the day"""
    user = db.get_or_create_user(callback.from_user.id, callback.from_user.username)
    energy_map_text = await generate_energy_map(user['id'])
    
    keyboard = InlineKeyboardBuilder()
    keyboard.button(text="üí° –°–æ–≤–µ—Ç –¥–Ω—è", callback_data="science_tip")
    keyboard.button(text="üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")
    keyboard.adjust(2)
    
    await callback.message.edit_text(
        energy_map_text,
        reply_markup=keyboard.as_markup(),
        parse_mode="HTML"
    )
    await callback.answer()


@dp.callback_query(F.data == "environment_analysis")
async def show_environment_analysis(callback: CallbackQuery):
    """Show environment analysis"""
    user = db.get_or_create_user(callback.from_user.id, callback.from_user.username)
    env_analysis_text = await generate_environment_analysis(user['id'])
    
    keyboard = InlineKeyboardBuilder()
    keyboard.button(text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑", callback_data="environment_analysis")
    keyboard.button(text="üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")
    keyboard.adjust(2)
    
    await callback.message.edit_text(
        env_analysis_text,
        reply_markup=keyboard.as_markup(),
        parse_mode="HTML"
    )
    await callback.answer()


@dp.callback_query(F.data == "science_facts")
async def show_science_facts(callback: CallbackQuery):
    """Show science facts menu"""
    await callback.message.edit_text(
        "üî¨ <b>–ù–∞—É—á–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ –≤—ã–≤–æ–¥—ã</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞—Ö:",
        reply_markup=create_science_facts_keyboard(),
        parse_mode="HTML"
    )
    await callback.answer()


@dp.callback_query(F.data == "science_tip")
async def show_science_tip(callback: CallbackQuery):
    """Show daily science tip"""
    tip = ai_analyzer.generate_science_tip_of_the_day()
    
    keyboard = InlineKeyboardBuilder()
    keyboard.button(text="üîô –ù–∞–∑–∞–¥ –∫ —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–æ–π –∫–∞—Ä—Ç–µ", callback_data="energy_map")
    keyboard.button(text="üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        f"üî¨ <b>–°–û–í–ï–¢ –û–¢ –ù–ê–£–ö–ò</b>\n\n{tip}",
        reply_markup=keyboard.as_markup(),
        parse_mode="HTML"
    )
    await callback.answer()


@dp.callback_query(F.data.startswith("add_journal_entry"))
async def start_adding_journal_entry(callback: CallbackQuery):
    """Start adding a journal entry"""
    await callback.message.edit_text(
        "üìù <b>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ –¥–Ω–µ–≤–Ω–∏–∫</b>\n\n"
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∞—à–µ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏. "
        "–ù–∞–ø—Ä–∏–º–µ—Ä: '–ó–≤–æ–Ω–æ–∫ –º–∞–º–µ', '–°–µ—Ä–∏–∞–ª 2 —á–∞—Å–∞', '–ó–∞—Ä—è–¥–∫–∞ 15 –º–∏–Ω—É—Ç'",
        reply_markup=InlineKeyboardBuilder().button(
            text="üîô –ù–∞–∑–∞–¥", callback_data="journal"
        ).as_markup(),
        parse_mode="HTML"
    )
    await callback.answer()


@dp.message(F.text)
async def handle_text_message(message: Message):
    """Handle text messages for journal entries"""
    user = db.get_or_create_user(message.from_user.id, message.from_user.username)
    
    # Analyze the activity
    analysis = ai_analyzer.analyze_activity(message.text)
    
    # Save to database
    success = db.add_journal_entry(
        user_id=user['id'],
        activity=message.text,
        duration=analysis.get('duration', 0),  # We could extract duration from text later
        ai_analysis=analysis['ai_analysis'],
        value_score=analysis['value_score'],
        category=analysis['category']
    )
    
    if success:
        response = f"‚úÖ <b>–ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞!</b>\n\n"
        response += f"üìù <b>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</b> {message.text}\n"
        response += f"ü§ñ <b>AI-–æ—Ü–µ–Ω–∫–∞:</b> {analysis['ai_analysis']}\n"
        response += f"üíé <b>–¶–µ–Ω–Ω–æ—Å—Ç—å:</b> {analysis['value_score']}/10\n"
        
        if analysis['scientific_recommendation']:
            response += f"\nüí° <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</b> {analysis['scientific_recommendation']}"
    else:
        response = "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    
    keyboard = InlineKeyboardBuilder()
    keyboard.button(text="üìù –ï—â–µ –∑–∞–ø–∏—Å—å", callback_data="add_journal_entry")
    keyboard.button(text="üìã –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–Ω–µ–≤–Ω–∏–∫", callback_data="journal")
    keyboard.button(text="üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")
    keyboard.adjust(2)
    
    await message.answer(response, reply_markup=keyboard.as_markup(), parse_mode="HTML")


@dp.callback_query(F.data == "full_analysis")
async def show_full_analysis(callback: CallbackQuery):
    """Show full AI analysis of user's activities"""
    user = db.get_or_create_user(callback.from_user.id, callback.from_user.username)
    entries = db.get_journal_entries(user['id'], days=7)
    
    if not entries:
        analysis_text = "ü§ñ <b>–ü–æ–ª–Ω—ã–π AI-–∞–Ω–∞–ª–∏–∑</b>\n\n"
        analysis_text += "–ü–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞. "
        analysis_text += "–î–æ–±–∞–≤—å—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –≤ –¥–Ω–µ–≤–Ω–∏–∫, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏."
    else:
        # Calculate overall statistics
        total_entries = len(entries)
        avg_score = sum([entry['value_score'] for entry in entries]) / total_entries if total_entries > 0 else 0
        
        high_value_count = len([e for e in entries if e['category'] == 'high_value'])
        medium_value_count = len([e for e in entries if e['category'] == 'medium_value'])
        low_value_count = len([e for e in entries if e['category'] == 'low_value'])
        negative_value_count = len([e for e in entries if e['category'] == 'negative_value'])
        
        analysis_text = "ü§ñ <b>–ü–æ–ª–Ω—ã–π AI-–∞–Ω–∞–ª–∏–∑</b>\n\n"
        analysis_text += f"<b>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π:</b>\n"
        analysis_text += f"   ‚Ä¢ –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {total_entries}\n"
        analysis_text += f"   ‚Ä¢ –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–Ω–æ—Å—Ç—å: {avg_score:.1f}/10\n\n"
        
        analysis_text += f"<b>üìà –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:</b>\n"
        analysis_text += f"   ‚Ä¢ –í—ã—Å–æ–∫–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å: {high_value_count} ({high_value_count/total_entries*100:.1f}%)\n"
        analysis_text += f"   ‚Ä¢ –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–Ω–æ—Å—Ç—å: {medium_value_count} ({medium_value_count/total_entries*100:.1f}%)\n"
        analysis_text += f"   ‚Ä¢ –ù–∏–∑–∫–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å: {low_value_count} ({low_value_count/total_entries*100:.1f}%)\n"
        analysis_text += f"   ‚Ä¢ –ù–µ–≥–∞—Ç–∏–≤–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å: {negative_value_count} ({negative_value_count/total_entries*100:.1f}%)\n\n"
        
        # Provide recommendations based on analysis
        if low_value_count + negative_value_count > high_value_count:
            analysis_text += "üí° <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</b> –í—ã–¥–µ–ª—è–π—Ç–µ –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –≤—ã—Å–æ–∫–æ—Ü–µ–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. "
            analysis_text += "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–º–µ–Ω–∏—Ç—å 30 –º–∏–Ω—É—Ç –Ω–∏–∑–∫–æ—Ü–µ–Ω–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–∞ –ø–æ–ª–µ–∑–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è.\n\n"
        
        # Find patterns
        most_common_activities = {}
        for entry in entries:
            activity = entry['activity'].lower()
            if activity not in most_common_activities:
                most_common_activities[activity] = 0
            most_common_activities[activity] += 1
        
        top_activities = sorted(most_common_activities.items(), key=lambda x: x[1], reverse=True)[:3]
        if top_activities:
            analysis_text += "<b>üéØ –í–∞—à–∏ –Ω–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:</b>\n"
            for activity, count in top_activities:
                analysis_text += f"   ‚Ä¢ {activity} - {count} —Ä–∞–∑(–∞)\n"
    
    keyboard = InlineKeyboardBuilder()
    keyboard.button(text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="full_analysis")
    keyboard.button(text="üìã –î–Ω–µ–≤–Ω–∏–∫", callback_data="journal")
    keyboard.button(text="üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")
    keyboard.adjust(2)
    
    await callback.message.edit_text(
        analysis_text,
        reply_markup=keyboard.as_markup(),
        parse_mode="HTML"
    )
    await callback.answer()


@dp.callback_query(F.data.startswith("science_"))
async def show_specific_science_fact(callback: CallbackQuery):
    """Show specific science fact"""
    category = callback.data.split("_", 1)[1]
    fact_text = await generate_science_fact(category)
    
    keyboard = InlineKeyboardBuilder()
    keyboard.button(text="üîô –ù–∞–∑–∞–¥ –∫ –Ω–∞—É—á–Ω—ã–º —Ñ–∞–∫—Ç–∞–º", callback_data="science_facts")
    keyboard.button(text="üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")
    keyboard.adjust(1)
    
    await callback.message.edit_text(
        fact_text,
        reply_markup=keyboard.as_markup(),
        parse_mode="HTML"
    )
    await callback.answer()


async def main():
    """Main function to run the bot"""
    logger.info("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ LifeOS Guardian...")
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())